{% extends "base.html" %}
{% load static %}
{% load crispy_forms_filters %}

{% debug %}


{% block search_bar %}
{% endblock search_bar %}


{% block header_left_column %}
<img style="margin-left: 1%;  width: 100%;" src="{% static '/images/VGR-logga.SVG'%}">

<a href="https://vgrinformatik.se/kodtjanst"><img style="width: 50%;" src="{% static 'images/tillbaka.svg' %}" alt="Navigera tillbaka till KOLLI"></a>
{% endblock header_left_column %}
{% block header_middle_column %}


{% endblock header_middle_column %}
{% block second_header_row %}
{% endblock second_header_row %}

{% block mitten-span %}

{% if kodverk_full %}



    <div class="row top-buffer-20">
        <div class="col-12 text-center">
            <button class="btn btn-outline-warning btn-sm" id="open_kommentera_button" data-toggle="modal" data-target="#Comment">
                <span class="fas fa-comment" style="font-size:smaller;"></span>&nbsp;Lämna synpunkter
            </button>        
            
            <button class="btn btn-outline-success btn-sm" id="open_verifiera_button" data-toggle="modal" data-target="#verify">
                <span class="fas fa-user-check" style="font-size:smaller;"> </span>&nbsp;Verifiera användning
            </button>
            
            <button type="button" class="btn btn-outline-info btn-sm" id="download_kodverk" onclick="location.href='{% url 'export_kodverk' kodverk_id %}'">
                <span class="fas fa-download" style="font-size:smaller;"></span>&nbsp;Ladda ner
            </button>
            
            <button type="button" class="btn btn-outline-info btn-sm" data-toggle="modal" data-target="#help">
                <span class="fas fa-question-circle" style="font-size:smaller;"></span>&nbsp;Hjälp
                <form id="opponera_term_form" action="{% url 'verify_comment_form' %}", method='POST'>{% csrf_token %}
                    {{ opponera|crispy }}
            </button>
        </div>
    </div>
    
    <hr>             

     <div class="row top-buffer-20" id="mitten-span-row">

        <!-- Alla metadata attribut -->
        <div class="col-1" id="mitten-span-left-spacer-column"></div>
        
        <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12" id="mitten-span-left-column text-centered col-centered">
                
            <div class="row">
                <div class="col-12 text-center">
                    <button class="btn btn-sm bg-info text-white" id="kodverk">
                        <strong>Kodverk</strong>
                    </button>
                </div>
            </div>
                
            <div class="row justify-content-md-center top-buffer-10 pr-1">
            <table id="komplett_metadata_tabell" class="table table-bordered table-striped table-md top-buffer-10">
            <tbody>
                    <tr>
                        <td colspan="2">Titel</td>
                        <td colspan="6"><strong>{{kodverk_full.titel_på_kodverk}}</strong></td>
                    </tr>
                    <tr>
                        <td colspan="2">Syfte</td>
                        <td colspan="6">{{kodverk_full.syfte}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Beskrivning av innehållet</td>
                        <td colspan="6">{{kodverk_full.beskrivning_av_innehållet }}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Användning</td>
                        <td colspan="6">{{kodverk_full.användning_av_kodverk}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Ägare till kodverk</td>
                        <td colspan="6">
                                        {% for attribute in codeconcept %}
                                            {{attribute.ägare_till_kodverk}}<br>
                                        {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">Giltig från</td>
                        <td colspan="6">{{kodverk_full.giltig_från}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Giltig tom</td>
                        <td colspan="6">{{kodverk_full.giltig_tom}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Senaste ändring</td>
                        <td colspan="6">{{kodverk_full.senaste_ändring}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Ansvarig förvaltare</td>
                        <td colspan="6">
                            {% for attribute in codeconcept %}
                            
                                {% if codeconcept|length > 1 %}
                                    {{attribute.ansvarig_förvaltare}} - ({{attribute.ägare_till_kodverk}})<br>
                                {% else %}
                                    {{attribute.ansvarig_förvaltare}}
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">Status</td>
                        <td colspan="6">{{kodverk_full.status}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">Beslutsunderlag dokument</td>
                        <td colspan="6" style="vertical-align:middle;">
                            {% if  kodverk_full.underlag|length > 0 %}
                                <a href="/kodtjanst/media/{{kodverk_full.underlag}}" id="underlagfil">
                                    <span class="fas fa-file-download fa-2x">
                                    </span>                            
                                </a>
                            {% else %}
                            Dokumentet saknas för tillfället
                            {% endif %}
                        </td>
                    </tr>
                
                    <tr>
                        <td colspan="2">Underlag länk</td>
                        <td colspan="6">
                        {% if kodverk_full.länk_till_underlag|length > 0 %}
                            <a href="{{kodverk_full.länk_till_underlag}}">{{kodverk_full.länk_till_underlag|slice:":50"}}</a>
                        {% else %}
                            Ingen länk
                        {% endif %}
                        </td>
                    </tr>
                    
                </tbody>
                </table>
            </div>
        </div>
                

        <!-- Själva kodtext -->
        
        {% if codeconcept|length > 1 %}

        <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12" id="mitten-span-right-column col-centered">
    
            <div class="row">
                <div class="col-12 text-center">
                    <button class="btn btn-sm bg-info text-white" id="kodverk">
                        <strong>Codeable Concept</strong>
                    </button>
                </div>
            </div>
    
            <p class="top-buffer-10">Denna kodverk är en codeable koncept. Kodtexter väljas från källorna
                som visas nedan vid användning kodverket. Kodtexter kan kommer från en av källorna, eller 
                man kan kombinera kodtexterna från alla källor.</p>
    
            <div class="row justify-content-md-center top-buffer-10 pl-1">
                <table class="table table-bordered table-striped table-md" style="width:100%">
                    <thead>
                        <tr>
                            <th>Källa</th>
                            <th>Länk</th>
                            <th>Information</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for i in kodtext_full %}
                    <tr>
                        <td>{{i.kod|default_if_none:"Ingen" }}</td>
                        <td>{{i.kodtext}}</td>
                        <td>{%if i.definition|length > 1 %}
                                {{i.definition}}
                            {% elif i.annan_kodtext|length > 1 %}
                                {{i.annan_kodtext}}
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
    
            </div>
    
    
        </div>
        </div>
    
    {% else %}
    
            <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12" id="mitten-span-right-column col-centered">
    
                <div class="row">
                    <div class="col-12 text-center">
                        <button class="btn btn-sm bg-info text-white" id="kodverk">
                            <strong>Kodtexter</strong>
                        </button>
                    </div>
                </div>
    
    
                <div class="row justify-content-md-center top-buffer-20 pl-1">
                    <table id="kodtext_tabell" name="kodtext_tabell" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Kod</th>
                                <th>Kodtext</th>
                                <th>                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                    {% if i.definition|length > 1 %}
                                        Definition
                                    {% elif i.annan_kodtext|length > 1 %}
                                        Annan kodtext
                                    {% else %}
                                        Övrig
                                    {% endif %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for i in kodtext_full %}
                        <tr>
                            <td>{{i.kod|default_if_none:"Ingen" }}</td>
                            <td>{{i.kodtext}}</td>
                            <td>{%if i.definition|length > 1 %}
                                    {{i.definition}}
                                {% elif i.annan_kodtext|length > 1 %}
                                    {{i.annan_kodtext}}
                                {% else %}
                                    &nbsp;
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}         
    
    <div class="col-1" id="mitten-span-right-spacer-column"></div>                  

    {% block help %}
        {% include "help.html" %}  
    {% endblock help %}

{% else %}
        <p>Ingen definition hittades...</p>
{% endif %}

{% endblock mitten-span %}

{% block extra_javascript %}
{{ super }}

<link rel="stylesheet" href="{% static '/css/main.css' %}" media="screen">
<script src="{% static '/js/jquery.dataTables.min.js' %}"></script>
<link rel="stylesheet" href="{% static '/css/jquery.dataTables.min.css' %}" media="screen">
<script>

/* Formatting function for row details - modify as you need */

function format (d) {
    // `d` is the original data object for the row
    return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
        '<tr>'+
            '<td>Kod:</td>'+
            '<td>'+d.kod+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>Kodtext:</td>'+
            '<td>'+d.kodtext+'</td>'+
        '</tr>'+
        '<tr>'+

            '<td>Annan kodtext:</td>'+
            '<td>'+d.annan_kodtext+'</td>'+
        '</tr>'+
    '</table>';
};

 // Add event listener for opening and closing details
 $('#kodtext_tabell tbody').on('click', 'td.details-control', function () {
     var tr = $(this).closest('tr');
     var row = table.row( tr );

     if ( row.child.isShown() ) {
         // This row is already open - close it
         row.child.hide();
         tr.removeClass('shown');
     }
     else {
         // Open this row
         row.child( format(row.data()) ).show();
         tr.addClass('shown');
     }
 } );

 $( document ).ready(function() {
             
    var table = $('#kodtext_tabell').removeAttr('width').DataTable({
        fixedColumns: true,
        columnDefs: [
            { width: 50, targets: 0},
            { width: 50, targets: 1},
            {targets: 1,
            className: 'breaklongline'}
        ],
        "stateSave" : true,
        "retrieve" : true,
        "initComplete": function(){ 
        $("#kodtext_tabell").show(); 
    },
        "language": {
            "url": "{% url 'translation_text' %}",
            "emptyTable": "Inga kodtexter som kan visas"
    }, 
    });
});
    
function showOptions() {
  var x = document.getElementById("showopt");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
	
	$("#opponera_term_form").submit(function(event){
		event.preventDefault(); //prevent default action 
		var post_url = $(this).attr("action"); //get form action url
		var request_method = $(this).attr("method"); //get form GET/POST method
		var form_data = $(this).serialize(); //Encode form elements for submission
		
		$.ajax({
			url : post_url,
			type: request_method,
			data : form_data
		}).done(function(response){ 
			$("#mitten-span-middle-column").html(response);
			setTimeout(function(){
				$("#mitten-span-middle-column").html('<div id="mitten-span-middle-column"></div>')}, 2500);
		});
    });
    
 
    $("#beställ_form").submit(function(event){
    event.preventDefault();
    var post_url = $(this).attr("action");
    var request_method = $(this).attr("method");
    var formdata = new FormData($(this)[0]);
    
    $.ajax({
        beforeSend: function (request)
            {
                request.setRequestHeader("X-CSRFTOKEN", "{{ csrf_token }}");
            },
        url : post_url,
        type: request_method,
        dataType: 'html',
        contentType: false,
        cache: false,
        processData:false,
        data : formdata,
        success : function(response){
            $("#mitten-span-middle-column").html(response);
            history.pushState(post_url, '', post_url)
            setTimeout(function(){
            $("#mitten-span-middle-column").html('<div id="mitten-span-middle-column"></div>')}, 2500);
            document.getElementById('user-input').value = '';
            history.replaceState('', 'VGR Informatik - KOLLI Kodtjänst', '/');
	    }
    });
});

    

function get_form_function(url, div_to_replace, type_method){
        
    $.ajax({
        url : url,
        type : type_method,
        success: function(response){
            $(div_to_replace).html(response);
        },
        error: function() {
    $(div_to_replace).html("There has been an error loading this form");
    },

    });

};

$(document).ready(function(){

$("#open_kommentera_button").click(function(){
    
    get_form_function(url="{% url 'verify_comment_form' %}?q={{kodverk_id}}&value=comment", 
                      div_to_replace="#populate_form_comment",
                      type_method="GET");
                    });
                      
$("#open_verifiera_button").click(function(){    
    
    get_form_function(url="{% url 'verify_comment_form' %}?q={{kodverk_id}}&value=verify",
                      div_to_replace="#populate_form_verify",
                      type_method="GET"); 
                    });
});

document.getElementById("underlagfil").addEventListener("click", function() {
    e.preventDefault();  //stop the browser from following
    window.location.href = "/kodtjanst/media/{{kodverk_full.underlag}}";
    console.log( "File served" );
});


</script>

{% endblock extra_javascript %}



